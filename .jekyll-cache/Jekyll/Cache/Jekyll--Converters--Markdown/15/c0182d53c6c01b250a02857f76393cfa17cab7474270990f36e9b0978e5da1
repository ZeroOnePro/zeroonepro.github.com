I"É8<h1 id="217-í”„ë¡œë¯¸ìŠ¤">2.1.7 í”„ë¡œë¯¸ìŠ¤</h1>

<p>ìë°”ìŠ¤í¬ë¦½íŠ¸ì™€ ë…¸ë“œì—ì„œëŠ” ì£¼ë¡œ ë¹„ë™ê¸°ë¥¼ ì ‘í•œë‹¤. íŠ¹íˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•  ë•Œ ì½œë°± í•¨ìˆ˜ë¥¼ ìì£¼ ì‚¬ìš©í•œë‹¤. ES6 ë¶€í„°ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì™€ ë…¸ë“œì˜ APIë“¤ì´ ì½œë°± ëŒ€ì‹  í”„ë¡œë¯¸ìŠ¤ê¸°ë°˜ìœ¼ë¡œ ì¬êµ¬ì„±ë˜ë©°, ì•…ëª… ë†’ì€ ì½œë°±ì§€ì˜¥í˜„ìƒì„ ê·¹ë³µí–ˆë‹¤ëŠ” í‰ê°€ë¥¼ ë°›ê³  ìˆë‹¤. í”„ë¡œë¯¸ìŠ¤ëŠ” ë°˜ë“œì‹œ ì•Œì•„ë‘ì.</p>

<p>í”„ë¡œë¯¸ìŠ¤ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê·œì¹™ì´ ìˆë‹¤.</p>

<ol>
  <li>ë¨¼ì € í”„ë¡œë¯¸ìŠ¤ ê°ì²´ë¥¼ ìƒì„±í•´ì•¼ í•œë‹¤.</li>
</ol>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">condition</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">condition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">success</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">reject</span><span class="p">(</span><span class="dl">"</span><span class="s2">failed</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">promise</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ì„±ê³µ ì‹œ</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ì‹¤íŒ¨ ì‹œ</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">finally</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">ë¬´ì¡°ê±´</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">new Promise</code> ë¡œ í”„ë¡œë¯¸ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©°, ê·¸ ë‚´ë¶€ì— resolveì™€ rejectë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ê°–ëŠ” ì½œë°± í•¨ìˆ˜ë¥¼ ë„£ëŠ”ë‹¤. ì´ë ‡ê²Œ ë§Œë“  promise ë³€ìˆ˜ì— thenê³¼ catch ë©”ì„œë“œë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤. í”„ë¡œë¯¸ìŠ¤ ë‚´ë¶€ì—ì„œ resolveê°€ í˜¸ì¶œë˜ë©´ thenì´ ì‹¤í–‰ë˜ê³ , rejectê°€ í˜¸ì¶œë˜ë©´ catchê°€ ì‹¤í–‰ëœë‹¤. finallyëŠ” ì„±ê³µ / ì‹¤íŒ¨ì— ê´€ê³„ì—†ì´ ì‹¤í–‰ëœë‹¤.</p>

<p>resolveì™€ rejectì— ë„£ì–´ì¤€ ì¸ìˆ˜ëŠ” ê°ê° thenê³¼ catchì˜ ë§¤ê°œë³€ìˆ˜ì—ì„œ ë°›ì„ ìˆ˜ ìˆë‹¤. ì¦‰, ìœ„ ì½”ë“œì˜ ê²½ìš°resolve(â€˜successâ€™)ì´ë¼í–ˆìœ¼ë‹ˆ, thenì˜ ë§¤ê°œë³€ìˆ˜ msgëŠ” â€˜successâ€™ê°€ ëœë‹¤ ë°˜ëŒ€ë¡œ rejectì˜ ê²½ìš°ëŠ” catchì˜ ë§¤ê°œë³€ìˆ˜ê°€ ëœë‹¤. errorëŠ” â€˜failedâ€™ê°€ ë  ê²ƒì´ë‹¤.</p>

<p>í”„ë¡œë¯¸ìŠ¤ëŠ” ì‰½ê²Œ ì„¤ëª…í•˜ì—¬, ì‹¤í–‰ì€ ë°”ë¡œ í•˜ë˜ ê²°ê³¼ê°’ì€ ë‚˜ì¤‘ì— ë°›ëŠ” ê°ì²´ì´ë‹¤. ê²°ê³¼ê°’ì€ thenì„ ë¶™ì˜€ì„ ë•Œ ë°›ê²Œ ëœë‹¤.</p>

<p>thenì´ë‚˜ catchì—ì„œ ë‹¤ì‹œ ë‹¤ë¥¸ thenì´ë‚˜ catchë¥¼ ë¶™ì¼ ìˆ˜ ìˆë‹¤. ì´ì „ thenì˜ return ê°’ì„ ë‹¤ìŒ thenì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ë„˜ê¸´ë‹¤. ë‹¨ ì—¬ê¸°ì„œ ë‹¤ìŒ thenì—ì„œ ë°›ìœ¼ë ¤ë©´ new Promiseë¥¼ ë¦¬í„´í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ìŠì§€ë§ì.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">promise</span>
	<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">msg1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">msg1</span><span class="p">));</span>
	<span class="p">})</span>
	<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">msg2</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">msg2</span><span class="p">));</span>
	<span class="p">})</span>
	<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">msg3</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">msg3</span><span class="p">));</span>
	<span class="p">})</span>
	<span class="p">...</span>
</code></pre></div></div>

<p>ì´ê²ƒì„ í™œìš©í•´ì„œ ì½œë°±ì„ í”„ë¡œë¯¸ìŠ¤ë¡œ ë°”ê¿€ ìˆ˜ ìˆë‹¤.</p>

<p>ë‹¤ìŒì€ ì½œë°±ì„ ì“°ëŠ” íŒ¨í„´ ì¤‘ í•˜ë‚˜ì´ë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">findAndSaveUser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Users</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// first callback</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
		<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">you</span><span class="dl">'</span><span class="p">;</span>
		<span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// second callback</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
			<span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">gender</span><span class="p">:</span> <span class="dl">'</span><span class="s1">m</span><span class="dl">'</span> <span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// third callback</span>
				<span class="p">...</span>
			<span class="p">})</span>
		<span class="p">});</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì½œë°± í•¨ìˆ˜ê°€ ì„¸ ë²ˆ ì¤‘ì²©ë˜ìˆë‹¤. ì½œë°± í•¨ìˆ˜ê°€ ë‚˜ì˜¬ ë•Œ ë§ˆë‹¤ ì½”ë“œì˜ depthëŠ” ê¹Šì–´ì§„ë‹¤. ê° ì½œë°± í•¨ìˆ˜ë§ˆë‹¤ ì—ëŸ¬ë„ ë”°ë¡œ ì²˜ë¦¬í•´ì¤˜ì•¼ í•œë‹¤. promiseë¥¼ ì´ìš©í•˜ì—¬ ìœ„ì˜ ì½”ë“œë¥¼ ë³€ê²½í•´ë³´ì</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">findAndSaveUser</span> <span class="o">=</span> <span class="p">(</span><span class="nx">Users</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="nx">Users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({})</span>
		<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
			<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">you</span><span class="dl">'</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span> <span class="c1">// ì´ëŠ” í”„ë¡œë¯¸ìŠ¤ ê°ì²´ë¥¼ ë¦¬í„´í•´ì•¼ í•œë‹¤.</span>
		<span class="p">})</span>
		<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
			<span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">you</span><span class="dl">'</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">gender</span><span class="p">:</span> <span class="dl">'</span><span class="s1">m</span><span class="dl">'</span> <span class="p">})</span> <span class="c1">// ë§ˆì°¬ê°€ì§€ë¡œ í”„ë¡œë¯¸ìŠ¤ ê°ì²´ë¥¼ ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜ì—¬ì•¼ í•œë‹¤.</span>
		<span class="p">})</span>
		<span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
			<span class="p">...</span>
		<span class="p">})</span>
		<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
		<span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì½”ë“œì˜ ê¹Šì´ê°€ ì„¸ ë‹¨ê³„ ì´ìƒ ê¹Šì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. ìœ„ ì½”ë“œì—£ ã…“then ë©”ì„œë“œë“¤ì€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤. ì½œë°±ì— ë§¤ë²ˆ ë”°ë¡œ ì²˜ë¦¬í•´ì•¼ í–‡ë˜ ì—ëŸ¬ë„ ë§ˆì§€ë§‰ catchì—ì„œ í•œ ë²ˆì— ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ëª¨ë“  ì½œë°± í•¨ìˆ˜ë¥¼ ìœ„ì™€ ê°™ì´ ë°”ê¿€ ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ë©”ì„œë“œê°€ í”„ë¡œë¯¸ìŠ¤ ë°©ì‹ì„ ì§€ì›í•´ì•¼í•œë‹¤. ë‹¤ì‹œ ë§í•´, ìœ„ì˜ ì˜ˆì‹œì—ì„œ user.saveì™€ User.findOneì´ promiseê°ì²´ë¥¼ ë¦¬í„´í•´ì•¼ í•œë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.</p>

<p>í”„ë¡œë¯¸ìŠ¤ ì—¬ëŸ¬ ê°œë¥¼ í•œ ë²ˆì— ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆë‹¤. ê¸°ì¡´ì˜ ì½œë°± íŒ¬í„´ì´ì—ˆë‹¤ë©´ ì½œë°±ì„ ì—¬ëŸ¬ ë²ˆ ì¤‘ì²©í•´ì„œ ì‚¬ìš©í•´ì•¼ í•  ê²ƒì´ë‚˜, í•˜ì§€ë§Œ <code class="language-plaintext highlighter-rouge">Promise.all</code> ì„ í™œìš©í•˜ë©´ ê°„ë‹¨íˆ í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">promise1</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">success 1</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">promise2</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">success 2</span><span class="dl">"</span><span class="p">);</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">promise1</span><span class="p">,</span> <span class="nx">promsie2</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>Promise.resolveëŠ” ì¦‰ì‹œ resolveí•˜ëŠ” í”„ë¡œë¯¸ìŠ¤ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì´ë‹¤. ë¹„ìŠ·í•œ ê²ƒìœ¼ë¡œ ì¦‰ì‹œ rejectë¥¼ í•˜ëŠ” Promise.rejectë„ ìˆë‹¤. í”„ë¡œë¯¸ìŠ¤ê°€ ì—¬ëŸ¬ ê°œ ìˆì„ ë•Œ <code class="language-plaintext highlighter-rouge">Promise.allì— ë„£ìœ¼ë©´ ëª¨ë‘ resolveë  ë•Œ ê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€</code> thenìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤. result ë§¤ê°œë³€ìˆ˜ì— ê°ê°ì˜ í”„ë¡œë¯¸ìŠ¤ ê²°ê´ê°’ì´ ë°°ì—´ë¡œ ë“¤ì–´ ìˆìŠµë‹ˆë‹¤. Promise ì¤‘ í•˜ë‚˜ë¼ë„ rejectê°€ ëœë‹¤ë©´ ë°”ë¡œ catchë¡œ ë„˜ì–´ê°„ë‹¤.</p>
:ET